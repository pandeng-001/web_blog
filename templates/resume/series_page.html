{% extends 'base.html' %}
{% load static %}
{% block title %}{{ series.name }} Â· {{ article.title|default:'æ–‡ç« ç³»åˆ—' }}{% endblock %}

{% block content %}
<div class="layui-container" style="margin-top:20px;">
    <div class="layui-row layui-col-space20">
        <!-- å·¦ä¾§ï¼šæ–‡ç« åˆ—è¡¨ + ç›®å½• -->
        <div class="layui-col-md3">
            <!-- ğŸ”¥ å¤–å±‚å®¹å™¨å®ç° sticky å›ºå®š -->
            <div class="sidebar-container">
                <!-- æ–‡ç« ç³»åˆ— -->
                <div class="layui-card series-card">
                    <div class="layui-card-header" style="font-weight:bold;background:#f8f8f8;">
                        <i class="layui-icon layui-icon-list"></i> {{ series.name }} ç³»åˆ—
                    </div>
                    <div class="layui-card-body" style="padding:10px;">
                        <ul class="series-menu-custom" id="series-menu">
                            {% for art in articles %}
                            <li class="{% if art.pk == article.pk %}active-item{% endif %}">
                                <a href="{% url 'resume:series_article' series.slug art.pk %}" data-pk="{{ art.pk }}">
                                    {{ art.title }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- ç›®å½• -->
                <div class="layui-card toc-card" style="margin-top:15px;">
                    <div class="layui-card-header" style="font-weight:bold;background:#f8f8f8;">
                        <i class="layui-icon layui-icon-list"></i> ç›®å½•
                    </div>
                    <div class="layui-card-body" style="padding:15px;">
                        <nav id="toc">
                            <div style="text-align:center;color:#999;padding:20px 0;">
                                <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
                                <div>åŠ è½½ç›®å½•ä¸­...</div>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ–‡ç« å†…å®¹ -->
        <div class="layui-col-md9">
            <div class="layui-card article-card">
                <div class="layui-card-header" style="background:#fff;border-bottom:1px solid #eee;">
                    <h1 id="article-title" style="margin:0;font-size:28px;line-height:1.5;">
                        {{ article.title|default:'è¯·é€‰æ‹©å·¦ä¾§æ–‡ç« ' }}
                    </h1>
                </div>
                <div class="layui-card-body markdown-body" id="article-content" style="padding:30px;line-height:1.8;">
                    {% if article %}
                    {{ article.content_html|safe }}
                    {% else %}
                    <p class="layui-text-center layui-text">ç‚¹å‡»å·¦ä¾§æ ‡é¢˜åŠ è½½å†…å®¹</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é˜…è¯»è¿›åº¦æ¡ -->
<div class="reading-progress" id="readingProgress"></div>

<style>
    /* ============================================
       ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¯ç”¨ Flex å¸ƒå±€ï¼ˆå¿…é¡»æ”¾æœ€å‰é¢ï¼‰
    ============================================ */
    .layui-row.layui-col-space20 {
        display: flex !important;
        flex-wrap: wrap;
    }

    .layui-col-md3,
    .layui-col-md9 {
        float: none !important;
    }

    /* ============================================
       å·¦ä¾§è¾¹æ å›ºå®šæ ·å¼ - å…³é”®ä¿®å¤
    ============================================ */
    .sidebar-container {
        position: -webkit-sticky; /* Safari å…¼å®¹ */
        position: sticky;
        top: 20px; /* è·ç¦»é¡¶éƒ¨çš„è·ç¦» */
        align-self: flex-start; /* é‡è¦ï¼šè®©stickyåœ¨flexå¸ƒå±€ä¸­ç”Ÿæ•ˆ */
        max-height: calc(100vh - 40px); /* æœ€å¤§é«˜åº¦ */
        overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶å¯æ»šåŠ¨ */
        z-index: 99;
    }

    /* ç¾åŒ–æ»šåŠ¨æ¡ */
    .sidebar-container::-webkit-scrollbar {
        width: 4px;
    }

    .sidebar-container::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 4px;
    }

    .sidebar-container::-webkit-scrollbar-thumb:hover {
        background: #bbb;
    }

    /* ============================================
       å¡ç‰‡æ ·å¼
    ============================================ */
    .series-card,
    .toc-card,
    .article-card {
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,.05);
        transition: all 0.3s;
    }

    .series-card:hover,
    .toc-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,.1);
        transform: translateY(-2px);
    }

    /* ============================================
       ç³»åˆ—æ–‡ç« åˆ—è¡¨æ ·å¼ - ğŸ”¥ å®Œå…¨è‡ªå®šä¹‰ï¼Œä¸ä¾èµ– layui
    ============================================ */
    .series-menu-custom {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .series-menu-custom li {
        transition: background-color .2s;
        border-radius: 4px;
        margin: 4px 0;
        cursor: pointer;
        background-color: transparent;
    }

    /* æ™®é€šé¡¹ hover */
    .series-menu-custom li:hover {
        background-color: #f0f9ff;
    }

    /* ğŸ”¥ é€‰ä¸­é¡¹èƒŒæ™¯ - ä½¿ç”¨ active-item è€Œä¸æ˜¯ layui-this */
    .series-menu-custom li.active-item {
        background-color: #1E9FFF !important;
    }

    /* ğŸ”¥ é€‰ä¸­é¡¹ hover æ—¶ä¿æŒè“è‰²èƒŒæ™¯ */
    .series-menu-custom li.active-item:hover {
        background-color: #1E9FFF !important;
    }

    /* é»˜è®¤æ–‡å­—é¢œè‰² */
    .series-menu-custom a {
        color: #555;
        text-decoration: none;
        display: block;
        padding: 10px 12px;
        transition: color .2s;
        font-size: 14px;
        line-height: 1.6;
    }

    /* æ™®é€šé¡¹ hover æ—¶æ–‡å­—å˜è“ */
    .series-menu-custom li:not(.active-item):hover a {
        color: #1E9FFF;
    }

    /* ğŸ”¥ é€‰ä¸­é¡¹æ–‡å­—å§‹ç»ˆä¿æŒç™½è‰²ï¼ˆå³ä½¿ hoverï¼‰ */
    .series-menu-custom li.active-item a {
        color: #fff !important;
        font-weight: bold;
    }

    /* ============================================
       ç›®å½•æ ·å¼
    ============================================ */
    #toc a {
        color: #555;
        text-decoration: none;
        display: block;
        padding: 8px 0 8px 10px;
        border-left: 2px solid transparent;
        margin-left: 0;
        transition: all 0.2s;
        font-size: 13px;
        line-height: 1.6;
    }

    #toc a:hover {
        color: #1E9FFF;
        background: #f0f9ff;
        border-left-color: #1E9FFF;
    }

    /* å½“å‰æ¿€æ´»çš„ç›®å½•é¡¹ */
    #toc a.active {
        color: #1E9FFF;
        font-weight: bold;
        background: #f0f9ff;
        border-left-color: #1E9FFF;
    }

    /* ç›®å½•å±‚çº§ç¼©è¿› */
    #toc a[data-level="1"] { padding-left: 10px; }
    #toc a[data-level="2"] { padding-left: 25px; }
    #toc a[data-level="3"] { padding-left: 40px; }
    #toc a[data-level="4"] { padding-left: 55px; }
    #toc a[data-level="5"] { padding-left: 70px; }
    #toc a[data-level="6"] { padding-left: 85px; }

    /* ============================================
       æ–‡ç« æ­£æ–‡æ ·å¼
    ============================================ */
    .markdown-body {
        font-size: 16px;
        color: #333;
    }

    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4,
    .markdown-body h5,
    .markdown-body h6 {
        margin-top: 30px;
        margin-bottom: 15px;
        font-weight: bold;
        color: #2c3e50;
        scroll-margin-top: 80px; /* é”šç‚¹è·³è½¬æ—¶çš„åç§» */
    }

    .markdown-body h1 { 
        font-size: 28px; 
        border-bottom: 2px solid #eee; 
        padding-bottom: 10px; 
    }
    
    .markdown-body h2 { 
        font-size: 24px; 
        border-bottom: 1px solid #eee; 
        padding-bottom: 8px; 
    }
    
    .markdown-body h3 { font-size: 20px; }
    .markdown-body h4 { font-size: 18px; }
    .markdown-body h5 { font-size: 16px; }
    .markdown-body h6 { font-size: 14px; color: #666; }

    .markdown-body p {
        margin: 15px 0;
        line-height: 1.8;
    }

    .markdown-body code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 14px;
        color: #e96900;
    }

    .markdown-body pre {
        background: #2d2d2d;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 15px 0;
    }

    .markdown-body pre code {
        color: #ccc;
        background: none;
    }

    .markdown-body img {
        max-width: 100%;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,.1);
        margin: 15px 0;
        display: block;
    }

    .markdown-body blockquote {
        border-left: 4px solid #1E9FFF;
        background: #f0f9ff;
        padding: 10px 15px;
        margin: 15px 0;
        color: #666;
    }

    .markdown-body ul, .markdown-body ol {
        padding-left: 30px;
        margin: 15px 0;
    }

    .markdown-body li {
        margin: 8px 0;
        line-height: 1.8;
    }

    .markdown-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }

    .markdown-body table th,
    .markdown-body table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }

    .markdown-body table th {
        background: #f5f5f5;
        font-weight: bold;
    }

    /* ============================================
       é˜…è¯»è¿›åº¦æ¡
    ============================================ */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: linear-gradient(90deg, #1E9FFF, #5FB878);
        z-index: 9999;
        transition: width 0.1s ease;
    }

    /* ============================================
       å“åº”å¼è®¾è®¡ - ğŸ”¥ ä¿®å¤å°å±å®½åº¦ä¸ä¸€è‡´é—®é¢˜
    ============================================ */
    @media screen and (max-width: 768px) {
        /* ç§»åŠ¨ç«¯å–æ¶ˆå›ºå®šå®šä½ */
        .sidebar-container {
            position: static;
            max-height: none;
            margin-bottom: 15px;
        }

        /* ğŸ”¥ å…³é”®ä¿®å¤ï¼šç¡®ä¿ç§»åŠ¨ç«¯å®½åº¦ä¸€è‡´ */
        .layui-container {
            padding-left: 15px !important;
            padding-right: 15px !important;
        }

        .layui-row.layui-col-space20 {
            margin: 0 !important;
        }

        .layui-col-md3,
        .layui-col-md9 {
            width: 100% !important;
            padding: 0 !important;
            margin-bottom: 15px;
        }

        /* ğŸ”¥ ç¡®ä¿å¡ç‰‡å®½åº¦ä¸€è‡´ */
        .series-card,
        .toc-card,
        .article-card {
            width: 100%;
            margin-left: 0;
            margin-right: 0;
        }

        /* è°ƒæ•´ç§»åŠ¨ç«¯å­—ä½“å’Œé—´è· */
        .markdown-body {
            font-size: 15px;
            padding: 20px !important;
        }

        #article-title {
            font-size: 22px !important;
            padding: 15px !important;
        }

        .article-card .layui-card-header {
            padding: 15px !important;
        }

        /* ç³»åˆ—åˆ—è¡¨ç§»åŠ¨ç«¯æ ·å¼ */
        .series-card .layui-card-body {
            padding: 8px !important;
        }

        .series-menu-custom a {
            font-size: 13px;
            padding: 8px 10px;
        }

        /* ç›®å½•ç§»åŠ¨ç«¯æ ·å¼ */
        .toc-card .layui-card-body {
            padding: 10px !important;
        }

        #toc a {
            font-size: 12px;
            padding: 6px 0 6px 8px;
        }

        /* ç›®å½•å±‚çº§ç¼©è¿›ï¼ˆç§»åŠ¨ç«¯ç¼©å°ï¼‰ */
        #toc a[data-level="1"] { padding-left: 8px; }
        #toc a[data-level="2"] { padding-left: 20px; }
        #toc a[data-level="3"] { padding-left: 32px; }
        #toc a[data-level="4"] { padding-left: 44px; }
        #toc a[data-level="5"] { padding-left: 56px; }
        #toc a[data-level="6"] { padding-left: 68px; }

        /* å¡ç‰‡å¤´éƒ¨ç§»åŠ¨ç«¯è°ƒæ•´ */
        .layui-card-header {
            font-size: 14px !important;
            padding: 12px 15px !important;
        }
    }

    /* é¡µé¢åŠ è½½åŠ¨ç”» */
    .series-card, .toc-card, .article-card {
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    /* ç»Ÿä¸€åœ¨ JS é‡Œæ‹¼å‰ç¼€ï¼Œé¿å…ç¡¬ç¼–ç è·¯å¾„ */
    const SERIES_SLUG = '{{ series.slug }}';

    /* åŠ è½½æŒ‡å®šæ–‡ç«  -> æ›´æ–°æ ‡é¢˜ + å†…å®¹ + ç›®å½• */
    function loadArticle(pk) {
        fetch(`/blog/series/${SERIES_SLUG}/article/${pk}/api`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('article-title').innerText = data.title;
                const contentBox = document.getElementById('article-content');
                contentBox.innerHTML = data.content_html;
                buildToc();
                highlightCurrentSection();
                history.replaceState(null, data.title, `/blog/series/${SERIES_SLUG}/article/${pk}/`);
                
                // ğŸ”¥ æ›´æ–°å·¦ä¾§é€‰ä¸­çŠ¶æ€
                layui.use('jquery', function($) {
                    $('#series-menu li').removeClass('active-item');
                    $(`#series-menu a[data-pk="${pk}"]`).parent().addClass('active-item');
                });
            });
    }

    /* ç”Ÿæˆç›®å½• */
    function buildToc() {
        layui.use(['jquery'], function ($) {
            const $toc = $('#toc').empty();
            const headers = $('#article-content').find('h1, h2, h3, h4, h5, h6');
            
            if (headers.length === 0) {
                $toc.html('<div style="text-align:center;color:#999;padding:20px;">æš‚æ— ç›®å½•</div>');
                return;
            }
            
            headers.each(function (idx) {
                const $header = $(this);
                const level = parseInt(this.tagName.substr(1));
                const id = this.id || 'heading-' + idx;
                const text = $header.text();
                
                // è®¾ç½®IDï¼ˆç”¨äºé”šç‚¹è·³è½¬ï¼‰
                $header.attr('id', id);
                
                // åˆ›å»ºç›®å½•é“¾æ¥
                const $link = $('<a></a>')
                    .attr('href', '#' + id)
                    .attr('data-level', level)
                    .attr('data-id', id)
                    .addClass('toc-link')
                    .text(text);
                
                $toc.append($link);
            });
            
            console.log('âœ… ç›®å½•ç”ŸæˆæˆåŠŸï¼Œå…± ' + headers.length + ' ä¸ªæ ‡é¢˜');
        });
    }

    /* é«˜äº®å½“å‰é˜…è¯»ä½ç½® */
    function highlightCurrentSection() {
        layui.use('jquery', function($) {
            const headers = $('#article-content').find('h1, h2, h3, h4, h5, h6');
            const scrollTop = $(window).scrollTop();
            let currentId = '';
            
            headers.each(function () {
                const $header = $(this);
                const headerTop = $header.offset().top - 100;
                
                if (scrollTop >= headerTop) {
                    currentId = $header.attr('id');
                }
            });
            
            // ç§»é™¤æ‰€æœ‰activeç±»
            $('.toc-link').removeClass('active');
            
            // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡é¢˜
            if (currentId) {
                const $activeLink = $('.toc-link[data-id="' + currentId + '"]');
                $activeLink.addClass('active');
                
                // è‡ªåŠ¨æ»šåŠ¨ç›®å½•ï¼Œç¡®ä¿å½“å‰é¡¹å¯è§
                const tocContainer = $('.toc-card .layui-card-body')[0];
                const activeElement = $activeLink[0];
                if (tocContainer && activeElement) {
                    const containerRect = tocContainer.getBoundingClientRect();
                    const elementRect = activeElement.getBoundingClientRect();
                    
                    if (elementRect.top < containerRect.top || elementRect.bottom > containerRect.bottom) {
                        activeElement.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                }
            }
        });
    }

    /* å·¦ä¾§åˆ—è¡¨ç‚¹å‡»æ— åˆ·æ–°ï¼šæ–‡å­— + æ•´è¡Œ */
    layui.use(['jquery'], function ($) {
        // æ–‡å­—ç‚¹å‡»
        $('#series-menu a').on('click', function (e) {
            e.preventDefault();
            loadArticle($(this).data('pk'));
        });

        // æ•´è¡Œï¼ˆliï¼‰ç‚¹å‡»
        $('#series-menu li').on('click', function (e) {
            // å¦‚æœç‚¹çš„å·²ç»æ˜¯ aï¼Œå°±ä¸ç®¡ï¼›å¦åˆ™å¸®å®ƒè§¦å‘
            if (e.target.tagName.toLowerCase() === 'a') return;
            const pk = $(this).find('a').data('pk');
            loadArticle(pk);
        });
        
        // ç›®å½•ç‚¹å‡»å¹³æ»‘æ»šåŠ¨
        $(document).on('click', '.toc-link', function (e) {
            e.preventDefault();
            const targetId = $(this).attr('href');
            const $target = $(targetId);
            
            if ($target.length) {
                $('html, body').animate({
                    scrollTop: $target.offset().top - 80
                }, 400);
            }
        });
        
        // æ»šåŠ¨æ—¶æ›´æ–°é«˜äº®ï¼ˆä½¿ç”¨èŠ‚æµä¼˜åŒ–æ€§èƒ½ï¼‰
        let scrollTimer = null;
        $(window).on('scroll', function () {
            if (scrollTimer) clearTimeout(scrollTimer);
            scrollTimer = setTimeout(function() {
                highlightCurrentSection();
                updateReadingProgress();
            }, 50);
        });
    });

    /* é˜…è¯»è¿›åº¦æ¡ */
    function updateReadingProgress() {
        const winScroll = document.documentElement.scrollTop || document.body.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        
        layui.use('jquery', function($) {
            $('#readingProgress').css('width', scrolled + '%');
        });
    }

    /* é¦–å±å°±ç”Ÿæˆç›®å½• */
    {% if article %} 
    layui.use('jquery', function($) {
        $(document).ready(function() {
            setTimeout(function() {
                buildToc();
                highlightCurrentSection();
                updateReadingProgress();
                console.log('âœ… ç³»åˆ—æ–‡ç« é¡µåˆå§‹åŒ–å®Œæˆ');
            }, 100);
        });
    });
    {% endif %}
</script>
{% endblock %}