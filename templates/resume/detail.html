{% extends 'base.html' %}
{% block title %}{{ article.title }}{% endblock %}
{% block content %}
{% load static %}
<div class="layui-container" style="margin-top:20px;">
    <div class="layui-row layui-col-space20">
        <!-- å·¦ä¾§ç›®å½• -->
        <div class="layui-col-md3">
            <!-- ç›´æ¥åœ¨è¿™é‡Œè®¾ç½®stickyï¼Œä¸è¦é¢å¤–åŒ…è£¹ -->
            <div class="toc-container">
                <div class="layui-card toc-card">
                    <div class="layui-card-header" style="font-weight:bold;background:#f8f8f8;">
                        <i class="layui-icon layui-icon-list"></i> æ–‡ç« ç›®å½•
                    </div>
                    <div class="layui-card-body" id="toc" style="padding:15px;">
                        <!-- ç”± JS è‡ªåŠ¨ç”Ÿæˆç›®å½• -->
                        <div style="text-align:center;color:#999;padding:20px 0;">
                            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
                            <div>åŠ è½½ç›®å½•ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§æ­£æ–‡ -->
        <div class="layui-col-md9">
            <div class="layui-card article-card">
                <div class="layui-card-header" style="background:#fff;border-bottom:1px solid #eee;">
                    <h1 style="margin:0;font-size:28px;line-height:1.5;">{{ article.title }}</h1>
                    <div style="margin-top:15px;font-size:13px;color:#999;">
                        <span style="margin-right:20px;">
                            <i class="layui-icon layui-icon-username"></i> {{ article.author|default:"ç®¡ç†å‘˜" }}
                        </span>
                        <span style="margin-right:20px;">
                            <i class="layui-icon layui-icon-date"></i> {{ article.created_at|date:"Y-m-d H:i" }}
                        </span>
                        <span style="margin-right:20px;">
                            <i class="layui-icon layui-icon-fire"></i> {{ article.views }} é˜…è¯»
                        </span>
                        {% if article.category %}
                        <span class="layui-badge layui-bg-blue">{{ article.category.name }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="layui-card-body markdown-body" id="articleContent" style="padding:30px;line-height:1.8;">
                    {{ article.content_html|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é˜…è¯»è¿›åº¦æ¡ -->
<div class="reading-progress" id="readingProgress"></div>

<!-- CSS æ ·å¼ -->
<style>
    /* ============================================
       ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¯ç”¨ Flex å¸ƒå±€ï¼ˆå¿…é¡»æ”¾æœ€å‰é¢ï¼‰
    ============================================ */
    .layui-row.layui-col-space20 {
        display: flex !important;
        flex-wrap: wrap;
    }

    .layui-col-md3,
    .layui-col-md9 {
        float: none !important;
    }

    /* ============================================
       ç›®å½•å›ºå®šæ ·å¼ - å…³é”®ä¿®å¤
    ============================================ */
    .toc-container {
        position: -webkit-sticky; /* Safari å…¼å®¹ */
        position: sticky;
        top: 20px; /* è·ç¦»é¡¶éƒ¨çš„è·ç¦»ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ */
        align-self: flex-start; /* é‡è¦ï¼šè®©stickyåœ¨flexå¸ƒå±€ä¸­ç”Ÿæ•ˆ */
        max-height: calc(100vh - 40px); /* æœ€å¤§é«˜åº¦ */
        overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶å¯æ»šåŠ¨ */
        z-index: 99;
    }

    /* ç¾åŒ–æ»šåŠ¨æ¡ */
    .toc-container::-webkit-scrollbar {
        width: 4px;
    }

    .toc-container::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 4px;
    }

    .toc-container::-webkit-scrollbar-thumb:hover {
        background: #bbb;
    }

    /* ç›®å½•å¡ç‰‡æ ·å¼ */
    .toc-card {
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,.05);
        transition: all 0.3s;
    }

    .toc-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,.1);
        transform: translateY(-2px);
    }

    /* ç›®å½•é“¾æ¥æ ·å¼ */
    #toc a {
        color: #555;
        text-decoration: none;
        display: block;
        padding: 8px 0 8px 10px;
        border-left: 2px solid transparent;
        margin-left: 0;
        transition: all 0.2s;
        font-size: 13px;
        line-height: 1.6;
    }

    #toc a:hover {
        color: #1E9FFF;
        background: #f0f9ff;
        border-left-color: #1E9FFF;
    }

    /* å½“å‰æ¿€æ´»çš„ç›®å½•é¡¹ */
    #toc a.active {
        color: #1E9FFF;
        font-weight: bold;
        background: #f0f9ff;
        border-left-color: #1E9FFF;
    }

    /* ç›®å½•å±‚çº§ç¼©è¿› */
    #toc a[data-level="1"] { padding-left: 10px; }
    #toc a[data-level="2"] { padding-left: 25px; }
    #toc a[data-level="3"] { padding-left: 40px; }
    #toc a[data-level="4"] { padding-left: 55px; }
    #toc a[data-level="5"] { padding-left: 70px; }
    #toc a[data-level="6"] { padding-left: 85px; }

    /* ============================================
       æ–‡ç« æ­£æ–‡æ ·å¼
    ============================================ */
    .article-card {
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,.05);
    }

    .markdown-body {
        font-size: 16px;
        color: #333;
    }

    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4,
    .markdown-body h5,
    .markdown-body h6 {
        margin-top: 30px;
        margin-bottom: 15px;
        font-weight: bold;
        color: #2c3e50;
        scroll-margin-top: 80px; /* é”šç‚¹è·³è½¬æ—¶çš„åç§» */
    }

    .markdown-body h1 { 
        font-size: 28px; 
        border-bottom: 2px solid #eee; 
        padding-bottom: 10px; 
    }
    
    .markdown-body h2 { 
        font-size: 24px; 
        border-bottom: 1px solid #eee; 
        padding-bottom: 8px; 
    }
    
    .markdown-body h3 { font-size: 20px; }
    .markdown-body h4 { font-size: 18px; }
    .markdown-body h5 { font-size: 16px; }
    .markdown-body h6 { font-size: 14px; color: #666; }

    .markdown-body p {
        margin: 15px 0;
        line-height: 1.8;
    }

    .markdown-body code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 14px;
        color: #e96900;
    }

    .markdown-body pre {
        background: #2d2d2d;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 15px 0;
    }

    .markdown-body pre code {
        color: #ccc;
        background: none;
    }

    .markdown-body img {
        max-width: 100%;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,.1);
        margin: 15px 0;
        display: block;
    }

    .markdown-body blockquote {
        border-left: 4px solid #1E9FFF;
        background: #f0f9ff;
        padding: 10px 15px;
        margin: 15px 0;
        color: #666;
    }

    .markdown-body ul, .markdown-body ol {
        padding-left: 30px;
        margin: 15px 0;
    }

    .markdown-body li {
        margin: 8px 0;
        line-height: 1.8;
    }

    .markdown-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }

    .markdown-body table th,
    .markdown-body table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }

    .markdown-body table th {
        background: #f5f5f5;
        font-weight: bold;
    }

    /* ============================================
       é˜…è¯»è¿›åº¦æ¡
    ============================================ */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: linear-gradient(90deg, #1E9FFF, #5FB878);
        z-index: 9999;
        transition: width 0.1s ease;
    }

    /* ============================================
       å“åº”å¼è®¾è®¡
    ============================================ */
    @media screen and (max-width: 768px) {
        .toc-container {
            position: static; /* ç§»åŠ¨ç«¯å–æ¶ˆå›ºå®š */
            max-height: none;
            margin-bottom: 15px;
        }

        .markdown-body {
            font-size: 15px;
            padding: 20px !important;
        }

        .article-card .layui-card-header h1 {
            font-size: 22px !important;
        }
    }

    /* é¡µé¢åŠ è½½åŠ¨ç”» */
    .toc-card, .article-card {
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<!-- JavaScript åŠŸèƒ½ -->
<script src="{% static 'layui-v2.11.6/layui/layui.js' %}"></script>
<script>
    layui.use(['jquery'], function ($) {
        const $toc = $('#toc');
        const $articleContent = $('#articleContent');
        
        // ============================================
        // åŠŸèƒ½1: ç”Ÿæˆç›®å½•
        // ============================================
        function generateTOC() {
            const headers = $articleContent.find('h1, h2, h3, h4, h5, h6');
            
            if (headers.length === 0) {
                $toc.html('<div style="text-align:center;color:#999;padding:20px;">æš‚æ— ç›®å½•</div>');
                return;
            }
            
            $toc.empty();
            
            headers.each(function (idx) {
                const $header = $(this);
                const level = parseInt(this.tagName.substr(1));
                const id = this.id || 'heading-' + idx;
                const text = $header.text();
                
                // è®¾ç½®IDï¼ˆç”¨äºé”šç‚¹è·³è½¬ï¼‰
                $header.attr('id', id);
                
                // åˆ›å»ºç›®å½•é“¾æ¥
                const $link = $('<a></a>')
                    .attr('href', '#' + id)
                    .attr('data-level', level)
                    .attr('data-id', id)
                    .addClass('toc-link')
                    .text(text);
                
                $toc.append($link);
            });
            
            console.log('âœ… ç›®å½•ç”ŸæˆæˆåŠŸï¼Œå…± ' + headers.length + ' ä¸ªæ ‡é¢˜');
        }
        
        // ============================================
        // åŠŸèƒ½2: å¹³æ»‘æ»šåŠ¨è·³è½¬
        // ============================================
        $(document).on('click', '.toc-link', function (e) {
            e.preventDefault();
            const targetId = $(this).attr('href');
            const $target = $(targetId);
            
            if ($target.length) {
                $('html, body').animate({
                    scrollTop: $target.offset().top - 80
                }, 400);
            }
        });
        
        // ============================================
        // åŠŸèƒ½3: é«˜äº®å½“å‰é˜…è¯»ä½ç½®
        // ============================================
        function highlightCurrentSection() {
            const headers = $articleContent.find('h1, h2, h3, h4, h5, h6');
            const scrollTop = $(window).scrollTop();
            let currentId = '';
            
            headers.each(function () {
                const $header = $(this);
                const headerTop = $header.offset().top - 100;
                
                if (scrollTop >= headerTop) {
                    currentId = $header.attr('id');
                }
            });
            
            // ç§»é™¤æ‰€æœ‰activeç±»
            $('.toc-link').removeClass('active');
            
            // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡é¢˜
            if (currentId) {
                const $activeLink = $('.toc-link[data-id="' + currentId + '"]');
                $activeLink.addClass('active');
                
                // è‡ªåŠ¨æ»šåŠ¨ç›®å½•ï¼Œç¡®ä¿å½“å‰é¡¹å¯è§
                const tocContainer = $('.toc-container')[0];
                const activeElement = $activeLink[0];
                if (tocContainer && activeElement) {
                    const containerRect = tocContainer.getBoundingClientRect();
                    const elementRect = activeElement.getBoundingClientRect();
                    
                    if (elementRect.top < containerRect.top || elementRect.bottom > containerRect.bottom) {
                        activeElement.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                }
            }
        }
        
        // æ»šåŠ¨æ—¶æ›´æ–°é«˜äº®ï¼ˆä½¿ç”¨èŠ‚æµä¼˜åŒ–æ€§èƒ½ï¼‰
        let scrollTimer = null;
        $(window).on('scroll', function () {
            if (scrollTimer) clearTimeout(scrollTimer);
            scrollTimer = setTimeout(highlightCurrentSection, 50);
        });
        
        // ============================================
        // åŠŸèƒ½4: é˜…è¯»è¿›åº¦æ¡
        // ============================================
        function updateReadingProgress() {
            const winScroll = document.documentElement.scrollTop || document.body.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            
            $('#readingProgress').css('width', scrolled + '%');
        }
        
        $(window).on('scroll', updateReadingProgress);
        
        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        $(document).ready(function () {
            // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†æ‰§è¡Œ
            setTimeout(function() {
                generateTOC();
                highlightCurrentSection();
                updateReadingProgress();
                console.log('âœ… æ–‡ç« è¯¦æƒ…é¡µåˆå§‹åŒ–å®Œæˆ');
                console.log('ğŸ“ stickyå®šä½å·²å¯ç”¨');
            }, 100);
        });
    });
</script>

<script>
// ğŸ”¥ æ”¾åœ¨æœ€å‰é¢ï¼Œè¯Šæ–­ sticky å¤±æ•ˆåŸå› 
layui.use('jquery', function($) {
    $(document).ready(function() {
        setTimeout(function() {
            const $toc = $('.toc-container');
            if (!$toc.length) {
                console.error('âŒ æ‰¾ä¸åˆ° .toc-container å…ƒç´ ');
                return;
            }
            
            console.log('=== ğŸ” Sticky å®Œæ•´è¯Šæ–­ ===');
            
            // æ£€æŸ¥è‡ªèº«æ ·å¼
            const tocStyle = window.getComputedStyle($toc[0]);
            console.log('1ï¸âƒ£ ç›®å½•è‡ªèº«:');
            console.log('  position:', tocStyle.position);
            console.log('  top:', tocStyle.top);
            console.log('  z-index:', tocStyle.zIndex);
            console.log('  display:', tocStyle.display);
            
            // ğŸ”¥ æ£€æŸ¥æ‰€æœ‰çˆ¶å…ƒç´ çš„ overflow
            console.log('\n2ï¸âƒ£ æ£€æŸ¥çˆ¶å…ƒç´  overflow (è¿™æ˜¯æœ€å¸¸è§çš„é—®é¢˜):');
            let element = $toc[0];
            let level = 0;
            
            while (element.parentElement) {
                element = element.parentElement;
                const style = window.getComputedStyle(element);
                const overflow = style.overflow;
                const overflowX = style.overflowX;
                const overflowY = style.overflowY;
                
                if (overflow !== 'visible' || overflowX !== 'visible' || overflowY !== 'visible') {
                    console.error(`  âŒ ${element.tagName}.${element.className}`);
                    console.error(`     overflow: ${overflow}, overflowX: ${overflowX}, overflowY: ${overflowY}`);
                } else {
                    console.log(`  âœ… ${element.tagName}.${element.className} - overflow: visible`);
                }
                
                level++;
                if (level > 10) break; // é˜²æ­¢æ— é™å¾ªç¯
            }
            
            // æ£€æŸ¥çˆ¶å…ƒç´ é«˜åº¦
            console.log('\n3ï¸âƒ£ æ£€æŸ¥çˆ¶å…ƒç´ é«˜åº¦:');
            const $parent = $toc.parent();
            console.log('  çˆ¶å…ƒç´ é«˜åº¦:', $parent.height(), 'px');
            console.log('  ç›®å½•é«˜åº¦:', $toc.height(), 'px');
            console.log('  çˆ¶å…ƒç´ å¿…é¡» > ç›®å½•é«˜åº¦:', $parent.height() > $toc.height());
            
            // æ£€æŸ¥ flex å¸ƒå±€
            console.log('\n4ï¸âƒ£ æ£€æŸ¥ Flex å¸ƒå±€:');
            const parentStyle = window.getComputedStyle($parent[0]);
            console.log('  çˆ¶å…ƒç´  display:', parentStyle.display);
            console.log('  align-self:', tocStyle.alignSelf);
            
            console.log('\n=== è¯Šæ–­å®Œæˆ ===\n');
        }, 500);
    });
});
</script>

{% endblock %}