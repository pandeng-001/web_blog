{% extends 'base.html' %}
{% block title %}{{ article.title }}{% endblock %}
{% block content %}
{% load static %}
<div class="layui-container" style="margin-top:20px;">
    <div class="layui-row layui-col-space20">
        <!-- 左侧目录 -->
        <div class="layui-col-md3">
            <!-- 直接在这里设置sticky，不要额外包裹 -->
            <div class="toc-container">
                <div class="layui-card toc-card">
                    <div class="layui-card-header" style="font-weight:bold;background:#f8f8f8;">
                        <i class="layui-icon layui-icon-list"></i> 文章目录
                    </div>
                    <div class="layui-card-body" id="toc" style="padding:15px;">
                        <!-- 由 JS 自动生成目录 -->
                        <div style="text-align:center;color:#999;padding:20px 0;">
                            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
                            <div>加载目录中...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧正文 -->
        <div class="layui-col-md9">
            <div class="layui-card article-card">
                <div class="layui-card-header" style="background:#fff;border-bottom:1px solid #eee;">
                    <h1 style="margin:0;font-size:28px;line-height:1.5;">{{ article.title }}</h1>
                    <div style="margin-top:15px;font-size:13px;color:#999;">
                        <span style="margin-right:20px;">
                            <i class="layui-icon layui-icon-username"></i> {{ article.author|default:"管理员" }}
                        </span>
                        <span style="margin-right:20px;">
                            <i class="layui-icon layui-icon-date"></i> {{ article.created_at|date:"Y-m-d H:i" }}
                        </span>
                        <span style="margin-right:20px;">
                            <i class="layui-icon layui-icon-fire"></i> {{ article.views }} 阅读
                        </span>
                        {% if article.category %}
                        <span class="layui-badge layui-bg-blue">{{ article.category.name }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="layui-card-body markdown-body" id="articleContent" style="padding:30px;line-height:1.8;">
                    {{ article.content_html|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 阅读进度条 -->
<div class="reading-progress" id="readingProgress"></div>

<!-- CSS 样式 -->
<style>
    /* ============================================
       🔥 关键修复：启用 Flex 布局（必须放最前面）
    ============================================ */
    .layui-row.layui-col-space20 {
        display: flex !important;
        flex-wrap: wrap;
    }

    .layui-col-md3,
    .layui-col-md9 {
        float: none !important;
    }

    /* ============================================
       目录固定样式 - 关键修复
    ============================================ */
    .toc-container {
        position: -webkit-sticky; /* Safari 兼容 */
        position: sticky;
        top: 20px; /* 距离顶部的距离，根据实际情况调整 */
        align-self: flex-start; /* 重要：让sticky在flex布局中生效 */
        max-height: calc(100vh - 40px); /* 最大高度 */
        overflow-y: auto; /* 内容过多时可滚动 */
        z-index: 99;
    }

    /* 美化滚动条 */
    .toc-container::-webkit-scrollbar {
        width: 4px;
    }

    .toc-container::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 4px;
    }

    .toc-container::-webkit-scrollbar-thumb:hover {
        background: #bbb;
    }

    /* 目录卡片样式 */
    .toc-card {
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,.05);
        transition: all 0.3s;
    }

    .toc-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,.1);
        transform: translateY(-2px);
    }

    /* 目录链接样式 */
    #toc a {
        color: #555;
        text-decoration: none;
        display: block;
        padding: 8px 0 8px 10px;
        border-left: 2px solid transparent;
        margin-left: 0;
        transition: all 0.2s;
        font-size: 13px;
        line-height: 1.6;
    }

    #toc a:hover {
        color: #1E9FFF;
        background: #f0f9ff;
        border-left-color: #1E9FFF;
    }

    /* 当前激活的目录项 */
    #toc a.active {
        color: #1E9FFF;
        font-weight: bold;
        background: #f0f9ff;
        border-left-color: #1E9FFF;
    }

    /* 目录层级缩进 */
    #toc a[data-level="1"] { padding-left: 10px; }
    #toc a[data-level="2"] { padding-left: 25px; }
    #toc a[data-level="3"] { padding-left: 40px; }
    #toc a[data-level="4"] { padding-left: 55px; }
    #toc a[data-level="5"] { padding-left: 70px; }
    #toc a[data-level="6"] { padding-left: 85px; }

    /* ============================================
       文章正文样式
    ============================================ */
    .article-card {
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,.05);
    }

    .markdown-body {
        font-size: 16px;
        color: #333;
    }

    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4,
    .markdown-body h5,
    .markdown-body h6 {
        margin-top: 30px;
        margin-bottom: 15px;
        font-weight: bold;
        color: #2c3e50;
        scroll-margin-top: 80px; /* 锚点跳转时的偏移 */
    }

    .markdown-body h1 { 
        font-size: 28px; 
        border-bottom: 2px solid #eee; 
        padding-bottom: 10px; 
    }
    
    .markdown-body h2 { 
        font-size: 24px; 
        border-bottom: 1px solid #eee; 
        padding-bottom: 8px; 
    }
    
    .markdown-body h3 { font-size: 20px; }
    .markdown-body h4 { font-size: 18px; }
    .markdown-body h5 { font-size: 16px; }
    .markdown-body h6 { font-size: 14px; color: #666; }

    .markdown-body p {
        margin: 15px 0;
        line-height: 1.8;
    }

    .markdown-body code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 14px;
        color: #e96900;
    }

    .markdown-body pre {
        background: #2d2d2d;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 15px 0;
    }

    .markdown-body pre code {
        color: #ccc;
        background: none;
    }

    .markdown-body img {
        max-width: 100%;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,.1);
        margin: 15px 0;
        display: block;
    }

    .markdown-body blockquote {
        border-left: 4px solid #1E9FFF;
        background: #f0f9ff;
        padding: 10px 15px;
        margin: 15px 0;
        color: #666;
    }

    .markdown-body ul, .markdown-body ol {
        padding-left: 30px;
        margin: 15px 0;
    }

    .markdown-body li {
        margin: 8px 0;
        line-height: 1.8;
    }

    .markdown-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }

    .markdown-body table th,
    .markdown-body table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }

    .markdown-body table th {
        background: #f5f5f5;
        font-weight: bold;
    }

    /* ============================================
       阅读进度条
    ============================================ */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: linear-gradient(90deg, #1E9FFF, #5FB878);
        z-index: 9999;
        transition: width 0.1s ease;
    }

    /* ============================================
       响应式设计
    ============================================ */
    @media screen and (max-width: 768px) {
        .toc-container {
            position: static; /* 移动端取消固定 */
            max-height: none;
            margin-bottom: 15px;
        }

        .markdown-body {
            font-size: 15px;
            padding: 20px !important;
        }

        .article-card .layui-card-header h1 {
            font-size: 22px !important;
        }
    }

    /* 页面加载动画 */
    .toc-card, .article-card {
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<!-- JavaScript 功能 -->
<script src="{% static 'layui-v2.11.6/layui/layui.js' %}"></script>
<script>
    layui.use(['jquery'], function ($) {
        const $toc = $('#toc');
        const $articleContent = $('#articleContent');
        
        // ============================================
        // 功能1: 生成目录
        // ============================================
        function generateTOC() {
            const headers = $articleContent.find('h1, h2, h3, h4, h5, h6');
            
            if (headers.length === 0) {
                $toc.html('<div style="text-align:center;color:#999;padding:20px;">暂无目录</div>');
                return;
            }
            
            $toc.empty();
            
            headers.each(function (idx) {
                const $header = $(this);
                const level = parseInt(this.tagName.substr(1));
                const id = this.id || 'heading-' + idx;
                const text = $header.text();
                
                // 设置ID（用于锚点跳转）
                $header.attr('id', id);
                
                // 创建目录链接
                const $link = $('<a></a>')
                    .attr('href', '#' + id)
                    .attr('data-level', level)
                    .attr('data-id', id)
                    .addClass('toc-link')
                    .text(text);
                
                $toc.append($link);
            });
            
            console.log('✅ 目录生成成功，共 ' + headers.length + ' 个标题');
        }
        
        // ============================================
        // 功能2: 平滑滚动跳转
        // ============================================
        $(document).on('click', '.toc-link', function (e) {
            e.preventDefault();
            const targetId = $(this).attr('href');
            const $target = $(targetId);
            
            if ($target.length) {
                $('html, body').animate({
                    scrollTop: $target.offset().top - 80
                }, 400);
            }
        });
        
        // ============================================
        // 功能3: 高亮当前阅读位置
        // ============================================
        function highlightCurrentSection() {
            const headers = $articleContent.find('h1, h2, h3, h4, h5, h6');
            const scrollTop = $(window).scrollTop();
            let currentId = '';
            
            headers.each(function () {
                const $header = $(this);
                const headerTop = $header.offset().top - 100;
                
                if (scrollTop >= headerTop) {
                    currentId = $header.attr('id');
                }
            });
            
            // 移除所有active类
            $('.toc-link').removeClass('active');
            
            // 添加active类到当前标题
            if (currentId) {
                const $activeLink = $('.toc-link[data-id="' + currentId + '"]');
                $activeLink.addClass('active');
                
                // 自动滚动目录，确保当前项可见
                const tocContainer = $('.toc-container')[0];
                const activeElement = $activeLink[0];
                if (tocContainer && activeElement) {
                    const containerRect = tocContainer.getBoundingClientRect();
                    const elementRect = activeElement.getBoundingClientRect();
                    
                    if (elementRect.top < containerRect.top || elementRect.bottom > containerRect.bottom) {
                        activeElement.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                }
            }
        }
        
        // 滚动时更新高亮（使用节流优化性能）
        let scrollTimer = null;
        $(window).on('scroll', function () {
            if (scrollTimer) clearTimeout(scrollTimer);
            scrollTimer = setTimeout(highlightCurrentSection, 50);
        });
        
        // ============================================
        // 功能4: 阅读进度条
        // ============================================
        function updateReadingProgress() {
            const winScroll = document.documentElement.scrollTop || document.body.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            
            $('#readingProgress').css('width', scrolled + '%');
        }
        
        $(window).on('scroll', updateReadingProgress);
        
        // ============================================
        // 初始化
        // ============================================
        $(document).ready(function () {
            // 确保DOM完全加载后再执行
            setTimeout(function() {
                generateTOC();
                highlightCurrentSection();
                updateReadingProgress();
                console.log('✅ 文章详情页初始化完成');
                console.log('📍 sticky定位已启用');
            }, 100);
        });
    });
</script>

<script>
// 🔥 放在最前面，诊断 sticky 失效原因
layui.use('jquery', function($) {
    $(document).ready(function() {
        setTimeout(function() {
            const $toc = $('.toc-container');
            if (!$toc.length) {
                console.error('❌ 找不到 .toc-container 元素');
                return;
            }
            
            console.log('=== 🔍 Sticky 完整诊断 ===');
            
            // 检查自身样式
            const tocStyle = window.getComputedStyle($toc[0]);
            console.log('1️⃣ 目录自身:');
            console.log('  position:', tocStyle.position);
            console.log('  top:', tocStyle.top);
            console.log('  z-index:', tocStyle.zIndex);
            console.log('  display:', tocStyle.display);
            
            // 🔥 检查所有父元素的 overflow
            console.log('\n2️⃣ 检查父元素 overflow (这是最常见的问题):');
            let element = $toc[0];
            let level = 0;
            
            while (element.parentElement) {
                element = element.parentElement;
                const style = window.getComputedStyle(element);
                const overflow = style.overflow;
                const overflowX = style.overflowX;
                const overflowY = style.overflowY;
                
                if (overflow !== 'visible' || overflowX !== 'visible' || overflowY !== 'visible') {
                    console.error(`  ❌ ${element.tagName}.${element.className}`);
                    console.error(`     overflow: ${overflow}, overflowX: ${overflowX}, overflowY: ${overflowY}`);
                } else {
                    console.log(`  ✅ ${element.tagName}.${element.className} - overflow: visible`);
                }
                
                level++;
                if (level > 10) break; // 防止无限循环
            }
            
            // 检查父元素高度
            console.log('\n3️⃣ 检查父元素高度:');
            const $parent = $toc.parent();
            console.log('  父元素高度:', $parent.height(), 'px');
            console.log('  目录高度:', $toc.height(), 'px');
            console.log('  父元素必须 > 目录高度:', $parent.height() > $toc.height());
            
            // 检查 flex 布局
            console.log('\n4️⃣ 检查 Flex 布局:');
            const parentStyle = window.getComputedStyle($parent[0]);
            console.log('  父元素 display:', parentStyle.display);
            console.log('  align-self:', tocStyle.alignSelf);
            
            console.log('\n=== 诊断完成 ===\n');
        }, 500);
    });
});
</script>

{% endblock %}